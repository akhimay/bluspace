<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz App with Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
      padding-top: 50px;
    }
    .container {
      max-width: 600px;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 30px;
      border-radius: 15px;
    }
    .hidden { display: none; }
    #adminToolbar { margin-bottom: 20px; }
    .question-img {
      max-width:100%; max-height:200px; display:block; margin: 0 auto 16px auto;
      border-radius:10px;
      background: #eee;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">QuizApp</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showLogin()">Login</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container hidden" id="loginPage">
    <h2 class="text-center mb-4">Login</h2>
    <form id="loginForm">
      <input type="text" id="loginUsername" class="form-control mb-2" placeholder="Username" required>
      <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Password" required>
      <button type="submit" class="btn btn-light w-100">Login</button>
    </form>
    <p class="text-center mt-3">Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
  </div>

  <div class="container hidden" id="registerPage">
    <h2 class="text-center mb-4">Register</h2>
    <form id="registerForm">
      <input type="text" id="registerUsername" class="form-control mb-2" placeholder="Username" required>
      <input type="password" id="registerPassword" class="form-control mb-2" placeholder="Password" required>
      <input type="email" id="registerEmail" class="form-control mb-2" placeholder="Email" required>
      <input type="file" id="registerAvatar" class="form-control mb-2" accept="image/*">
      <button type="submit" class="btn btn-light w-100">Register</button>
    </form>
  </div>

  <div class="container hidden" id="quizPage">
    <h2 class="text-center mb-4">Quiz</h2>
    <div id="quizQuestionImage"></div>
    <div id="quizQuestion" class="mb-3 fs-5"></div>
    <div id="quizTimer" class="mb-3 text-warning"></div>
    <div id="quizAnswer" class="text-success fw-bold"></div>
    <button class="btn btn-light mt-3" onclick="nextQuestion()" id="nextQuestionBtn">Next Question</button>
    <button class="btn btn-secondary mt-3 ms-2" onclick="showUserProfile()" id="showUserProfileBtn">Profile</button>
  </div>

  <!-- User profile for regular users -->
  <div class="container hidden" id="userProfileSection">
    <h2 class="text-center mb-4">My Profile</h2>
    <form id="userProfileForm">
      <div class="text-center">
        <img id="userAvatarPreview" src="" class="rounded-circle mb-3" width="100" height="100" alt="avatar">
        <input type="file" id="userUpdateAvatar" class="form-control mb-2" accept="image/*">
      </div>
      <input type="text" id="userUpdateUsername" class="form-control mb-2" required>
      <input type="email" id="userUpdateEmail" class="form-control mb-2" required>
      <input type="password" id="userUpdatePassword" class="form-control mb-2" required>
      <button class="btn btn-light w-100">Update Profile</button>
      <button type="button" class="btn btn-secondary mt-2 w-100" onclick="returnToQuiz()">Return to Quiz</button>
    </form>
  </div>

  <div class="container hidden" id="adminPanel">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" id="adminToolbar">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Panel</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showUserManagement()">User Management</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showAddQuestion()">Add Questions</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showProfileSection()">Profile</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div id="adminContent">
      <p>Select a section from above toolbar</p>
    </div>
  </div>

<script>
    // ---- Persistence Functions ----
    function loadData() {
      users = JSON.parse(localStorage.getItem('quizUsers')) || [
        { username: 'admin', password: 'admin', role: 'admin', email: 'admin@example.com', avatar: 'https://via.placeholder.com/100' },
        { username: 'user', password: '1234', role: 'user', email: 'user@example.com', avatar: 'https://via.placeholder.com/100' }
      ];
      questions = JSON.parse(localStorage.getItem('quizQuestions')) || [
        { question: "What is the capital of France?", answer: "Paris" },
        { question: "What is 2 + 2?", answer: "4" },
        { question: "What is the capital of India?", answer: "New Delhi" }
      ];
    }

    function saveUsers() {
      localStorage.setItem('quizUsers', JSON.stringify(users));
    }
    function saveQuestions() {
      localStorage.setItem('quizQuestions', JSON.stringify(questions));
    }

    // ---------- Initialize data ----------
    let users, questions; // will be filled by loadData()
    let currentUser = null;
    loadData();

    function showLogin() {
      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('registerPage').classList.add('hidden');
      document.getElementById('quizPage').classList.add('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('userProfileSection').classList.add('hidden');
    }

    function showRegister() {
      document.getElementById('registerPage').classList.remove('hidden');
      document.getElementById('loginPage').classList.add('hidden');
    }

    document.getElementById('registerForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const uname = document.getElementById('registerUsername').value;
      const pwd = document.getElementById('registerPassword').value;
      const email = document.getElementById('registerEmail').value;
      const avatarFile = document.getElementById('registerAvatar').files[0];

      if (users.some(u => u.username === uname)) {
        alert('Username already taken!');
        return;
      }

      const reader = new FileReader();
      reader.onloadend = () => {
        const avatarURL = reader.result;
        users.push({ username: uname, password: pwd, email: email, role: 'user', avatar: avatarURL });
        saveUsers();
        alert('Registered successfully! Now you can login.');
        showLogin();
      };
      if (avatarFile) {
        reader.readAsDataURL(avatarFile);
      } else {
        users.push({ username: uname, password: pwd, email: email, role: 'user', avatar: 'https://via.placeholder.com/100' });
        saveUsers();
        alert('Registered successfully! Now you can login.');
        showLogin();
      }
    });

    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const uname = document.getElementById('loginUsername').value;
      const pwd = document.getElementById('loginPassword').value;
      const user = users.find(u => u.username === uname && u.password === pwd);

      if (!user) return alert('Invalid credentials');

      currentUser = user;
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('registerPage').classList.add('hidden');
      document.getElementById('userProfileSection').classList.add('hidden');

      if (user.role === 'admin') {
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('quizPage').classList.add('hidden');
      } else {
        document.getElementById('quizPage').classList.remove('hidden');
        document.getElementById('adminPanel').classList.add('hidden');
        loadQuestion();
      }
    });

    // For the Next Question button
    let quizQuestionTimeout = null;
    let quizQuestionInterval = null;
    let currentQuizQuestionIndex = -1;

    function nextQuestion() {
      if (quizQuestionInterval) clearInterval(quizQuestionInterval);
      if (quizQuestionTimeout) clearTimeout(quizQuestionTimeout);
      loadQuestion();
    }

    function loadQuestion() {
      const questionBox = document.getElementById('quizQuestion');
      const answerBox = document.getElementById('quizAnswer');
      const timerBox = document.getElementById('quizTimer');
      const imgBox = document.getElementById('quizQuestionImage');

      // Get a different random question from previous if possible
      let idx;
      do {
        idx = Math.floor(Math.random() * questions.length);
      } while (questions.length > 1 && idx === currentQuizQuestionIndex);

      currentQuizQuestionIndex = idx;
      const q = questions[idx];

      questionBox.innerText = q.question;
      answerBox.innerText = '';
      if (q.img) {
        imgBox.innerHTML = `<img src="${q.img}" class="question-img mb-2" alt="Question Image">`;
      } else {
        imgBox.innerHTML = "";
      }
      let count = 10;
      timerBox.innerText = `Time left: ${count}s`;

      quizQuestionInterval = setInterval(() => {
        count--;
        timerBox.innerText = `Time left: ${count}s`;
        if (count === 0) {
          clearInterval(quizQuestionInterval);
          answerBox.innerText = `Answer: ${q.answer}`;
          quizQuestionTimeout = setTimeout(() => loadQuestion(), 3000);
        }
      }, 1000);
    }

    function showUserManagement() {
      let userRows = users.map((u, i) => `
        <tr>
          <td>${u.username}</td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td><img src="${u.avatar}" width="40" height="40" style="border-radius:20px"></td>
          <td>
            ${u.role !== 'admin' ?
              `<button class="btn btn-sm btn-danger" onclick="removeUser(${i})">Delete</button>` : ''}
          </td>
        </tr>`).join('');
      document.getElementById('adminContent').innerHTML = `
        <h4>User Management</h4>
        <table class="table table-dark table-striped align-middle">
          <thead>
            <tr><th>Username</th><th>Email</th><th>Role</th><th>Avatar</th><th>Action</th></tr>
          </thead>
          <tbody>
            ${userRows}
          </tbody>
        </table>
      `;
    }

    function removeUser(idx) {
      if (confirm(`Delete user '${users[idx].username}'?`)) {
        users.splice(idx, 1);
        saveUsers();
        showUserManagement();
      }
    }

    function showAddQuestion() {
      document.getElementById('adminContent').innerHTML = `
        <h4>Add a Question</h4>
        <form id="addQuestionForm">
          <input class="form-control mb-2" id="newQuestion" placeholder="Enter Question" required>
          <input class="form-control mb-2" id="newAnswer" placeholder="Enter Answer" required>
          <input type="file" class="form-control mb-2" id="newQuestionImage" accept="image/*">
          <img id="addQPreviewImg" class="question-img mb-2" style="display:none;" />
          <button class="btn btn-light">Add</button>
        </form>
        <h5 class="mt-4">All Questions</h5>
        <ul id="adminQuestionsList" class="list-group"></ul>
      `;
      document.getElementById('newQuestionImage').addEventListener('change', function () {
        const file = this.files[0];
        const preview = document.getElementById('addQPreviewImg');
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = 'none';
        }
      });
      document.getElementById('addQuestionForm').addEventListener('submit', addQuestion);
      renderQuestionsList();
    }

    function addQuestion(event) {
      event.preventDefault();
      const q = document.getElementById('newQuestion').value;
      const a = document.getElementById('newAnswer').value;
      const imgFile = document.getElementById('newQuestionImage').files[0];
      if (imgFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          questions.push({ question: q, answer: a, img: e.target.result });
          saveQuestions();
          alert('Question added!');
          showAddQuestion();
        };
        reader.readAsDataURL(imgFile);
      } else {
        questions.push({ question: q, answer: a });
        saveQuestions();
        alert('Question added!');
        showAddQuestion();
      }
    }

    function renderQuestionsList() {
      const list = document.getElementById('adminQuestionsList');
      if (!list) return;
      list.innerHTML = questions.map((q, i) =>
        `<li class="list-group-item bg-dark text-light d-flex justify-content-between align-items-center">
          <span>
            ${i + 1}. ${q.question}
            <span class="text-secondary small">(Ans: ${q.answer})</span>
            ${q.img ? `<br><img src="${q.img}" style="width:80px;max-height:60px;border-radius:5px;margin-top:3px;">` : ''}
          </span>
          <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${i})">Delete</button>
         </li>`
      ).join('');
    }

    function deleteQuestion(idx) {
      if (confirm(`Delete this question?`)) {
        questions.splice(idx, 1);
        saveQuestions();
        renderQuestionsList();
      }
    }

    function showProfileSection() {
      document.getElementById('adminContent').innerHTML = `
        <h4>Profile</h4>
        <form onsubmit="updateProfile(event)">
          <div class="text-center">
            <img id="avatarPreview" src="${currentUser.avatar}" class="rounded-circle mb-3" width="100" height="100" alt="avatar">
            <input type="file" id="updateAvatar" class="form-control mb-2" accept="image/*">
          </div>
          <input type="text" id="updateUsername" class="form-control mb-2" value="${currentUser.username}" required>
          <input type="email" id="updateEmail" class="form-control mb-2" value="${currentUser.email}" required>
          <input type="password" id="updatePassword" class="form-control mb-2" value="${currentUser.password}" required>
          <button class="btn btn-light w-100">Update Profile</button>
        </form>
      `;
    }

    function updateProfile(event) {
      event.preventDefault();
      const newUsername = document.getElementById('updateUsername').value;
      const newEmail = document.getElementById('updateEmail').value;
      const newPassword = document.getElementById('updatePassword').value;
      const newAvatarFile = document.getElementById('updateAvatar').files[0];

      // Check for username conflicts
      if (newUsername !== currentUser.username && users.some(u => u.username === newUsername)) {
        alert('Username already taken!');
        return;
      }

      currentUser.username = newUsername;
      currentUser.email = newEmail;
      currentUser.password = newPassword;

      if (newAvatarFile) {
        const reader = new FileReader();
        reader.onloadend = () => {
          currentUser.avatar = reader.result;
          saveUsers();
          alert('Profile updated!');
          showProfileSection();
        };
        reader.readAsDataURL(newAvatarFile);
      } else {
        saveUsers();
        alert('Profile updated!');
        showProfileSection();
      }
    }

    // User profile (for normal users)
    function showUserProfile() {
      document.getElementById('userProfileSection').classList.remove('hidden');
      document.getElementById('quizPage').classList.add('hidden');
      // Fill fields with current user's data
      document.getElementById('userAvatarPreview').src = currentUser.avatar;
      document.getElementById('userUpdateUsername').value = currentUser.username;
      document.getElementById('userUpdateEmail').value = currentUser.email;
      document.getElementById('userUpdatePassword').value = currentUser.password;
      const avatarInput = document.getElementById('userUpdateAvatar');
      avatarInput.value = '';
      avatarInput.onchange = function () {
        const file = avatarInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            document.getElementById('userAvatarPreview').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      };
    }
    document.getElementById('userProfileForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const newUsername = document.getElementById('userUpdateUsername').value;
      const newEmail = document.getElementById('userUpdateEmail').value;
      const newPassword = document.getElementById('userUpdatePassword').value;
      const newAvatarFile = document.getElementById('userUpdateAvatar').files[0];

      // Prevent user from picking an existing username
      if (
        newUsername !== currentUser.username &&
        users.some(u => u.username === newUsername)
      ) {
        alert('Username already taken!');
        return;
      }

      currentUser.username = newUsername;
      currentUser.email = newEmail;
      currentUser.password = newPassword;

      if (newAvatarFile) {
        const reader = new FileReader();
        reader.onloadend = () => {
          currentUser.avatar = reader.result;
          saveUsers();
          alert('Profile updated!');
          showUserProfile();
        };
        reader.readAsDataURL(newAvatarFile);
      } else {
        saveUsers();
        alert('Profile updated!');
        showUserProfile();
      }
    });

    function returnToQuiz() {
      document.getElementById('userProfileSection').classList.add('hidden');
      document.getElementById('quizPage').classList.remove('hidden');
    }

    // Enable usage from inline HTML handlers
    window.showUserManagement = showUserManagement;
    window.showAddQuestion = showAddQuestion;
    window.showProfileSection = showProfileSection;
    window.addQuestion = addQuestion;
    window.deleteQuestion = deleteQuestion;
    window.removeUser = removeUser;
    window.showUserProfile = showUserProfile;
    window.returnToQuiz = returnToQuiz;
    window.nextQuestion = nextQuestion;

    // Show login as default page
    showLogin();
</script>
</body>
</html>
